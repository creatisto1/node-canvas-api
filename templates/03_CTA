const { createCanvas } = require('canvas');

module.exports = async function generateTemplate_03_CTA(img, overlayText, targetWidth, targetHeight, website) {
  const canvas = createCanvas(targetWidth, targetHeight);
  const ctx = canvas.getContext('2d');

  // === Konstante Höhe für unteren gelben Bereich ===
  const bottomAreaHeight = 495;
  const imageAreaHeight = targetHeight - bottomAreaHeight;

  // === Hintergrund komplett Gelb ===
  ctx.fillStyle = '#FFF9D9'; // Helles Gelb
  ctx.fillRect(0, 0, targetWidth, targetHeight);

  // === Bild proportional skalieren & zentrieren im Bildbereich ===
  const imgAspect = img.width / img.height;
  const areaAspect = targetWidth / imageAreaHeight;

  let drawWidth, drawHeight;
  if (imgAspect > areaAspect) {
    drawHeight = imageAreaHeight;
    drawWidth = drawHeight * imgAspect;
  } else {
    drawWidth = targetWidth;
    drawHeight = drawWidth / imgAspect;
  }

  const drawX = (targetWidth - drawWidth) / 2;
  const drawY = (imageAreaHeight - drawHeight) / 2;
  ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);

  // === Overlay Text ===
  const headlineFontSize = Math.floor(targetHeight * 0.045);
  ctx.fillStyle = '#4F4F4F';
  ctx.font = `bold ${headlineFontSize}px "Averta"`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(overlayText, targetWidth / 2, imageAreaHeight + 50); // 50px unter dem Bildbereich

  // === Button "JETZT BESUCHEN" ===
  const buttonText = 'JETZT BESUCHEN';
  const buttonFontSize = Math.floor(targetHeight * 0.035);
  const buttonPaddingX = 40;
  const buttonPaddingY = 20;

  ctx.font = `bold ${buttonFontSize}px "Averta"`;
  const textWidth = ctx.measureText(buttonText).width;
  const buttonWidth = textWidth + buttonPaddingX * 2;
  const buttonHeight = buttonFontSize + buttonPaddingY * 2;
  const buttonX = targetWidth / 2 - buttonWidth / 2;

  // Position Button ca. 110px unter dem Overlay-Text
  const buttonY = imageAreaHeight + 50 + headlineFontSize + 30;

  ctx.fillStyle = '#4AC2C2'; // Türkis
  ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);

  ctx.fillStyle = '#FFFFFF';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(buttonText, targetWidth / 2, buttonY + buttonHeight / 2);

  // === Website-URL unter dem Button ===
  const urlText = website || "www.creatisto.com";
  const urlFontSize = Math.floor(headlineFontSize * 0.5);
  ctx.font = `bold ${urlFontSize}px "Averta"`;
  ctx.fillStyle = '#4F4F4F';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(urlText, targetWidth / 2, buttonY + buttonHeight + 10);

  return canvas;
};
