const { createCanvas } = require('canvas');

module.exports = async function generateTemplate_03_CTA(img, overlayText, targetWidth, targetHeight, website) {
  const canvas = createCanvas(targetWidth, targetHeight);
  const ctx = canvas.getContext('2d');

  // === Hintergrundfarbe unten ===
  ctx.fillStyle = '#FDF8F6';
  ctx.fillRect(0, 0, targetWidth, targetHeight);

  // === Oben zentrales Bild (proportional zentriert und beschnitten) ===
  const topImageHeight = targetHeight * 0.6;

  // Originalbildmaße
  const imgWidth = img.width;
  const imgHeight = img.height;

  // Berechne Skalierung, um das Bild so zu skalieren, dass es das Canvas-Bereich (topImageHeight x targetWidth) vollständig ausfüllt
  const scale = Math.max(targetWidth / imgWidth, topImageHeight / imgHeight);

  // Berechnete Größe des Bildes nach Skalierung
  const scaledWidth = imgWidth * scale;
  const scaledHeight = imgHeight * scale;

  // Berechne die Startpunkte für zentrierten Zuschnitt
  const sx = (scaledWidth - targetWidth) / 2 / scale;  // Ursprung x im Originalbild
  const sy = (scaledHeight - topImageHeight) / 2 / scale;  // Ursprung y im Originalbild
  const sWidth = targetWidth / scale;
  const sHeight = topImageHeight / scale;

  // Zeichne das zugeschnittene und skalierte Bild
  ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, targetWidth, topImageHeight);

  // === Overlay Text (Überschrift) ===
  const headlineFontSize = Math.floor(targetHeight * 0.045);
  ctx.fillStyle = '#4F4F4F';
  ctx.font = `bold ${headlineFontSize}px "Averta"`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(overlayText, targetWidth / 2, topImageHeight + 50);

  // === Button "JETZT BESUCHEN" ===
  const buttonText = 'JETZT BESUCHEN';
  const buttonFontSize = Math.floor(targetHeight * 0.035);
  const buttonPaddingX = 40;
  const buttonPaddingY = 20;

  ctx.font = `bold ${buttonFontSize}px "Averta"`;
  const textWidth = ctx.measureText(buttonText).width;
  const buttonWidth = textWidth + buttonPaddingX * 2;
  const buttonHeight = buttonFontSize + buttonPaddingY * 2;
  const buttonX = targetWidth / 2 - buttonWidth / 2;
  const buttonY = targetHeight * 0.82;

  // Button Hintergrund
  ctx.fillStyle = '#A25C48';
  ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);

  // Button Text
  ctx.fillStyle = '#FFFFFF';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(buttonText, targetWidth / 2, buttonY + buttonHeight / 2);

  // === URL unter dem Button ===
  const urlText = website || "www.creatisto.com";
  const urlFontSize = Math.floor(headlineFontSize * 0.5);
  ctx.font = `bold ${urlFontSize}px "Averta"`;
  ctx.fillStyle = '#4F4F4F';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';

  const urlY = buttonY + buttonHeight + 12;
  ctx.fillText(urlText, targetWidth / 2, urlY);

  return canvas;
};
